<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#5865F2" />
  <title>Discord Bot DM Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0b14;
      --bg-card: #111225;
      --bg-input: #181a30;
      --bg-hover: #1e2040;
      --border: #252842;
      --text: #e4e5f1;
      --text-muted: #7c7fa0;
      --text-dim: #4e5073;
      --primary: #5865F2;
      --primary-hover: #4752c4;
      --success: #43b581;
      --danger: #f04747;
      --warning: #faa61a;
      --orange: #e67e22;
      --info: #5865F2;
      --radius: 8px;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ── Header ── */
    .header {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .header-icon {
      width: 42px; height: 42px;
      background: var(--primary);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
    }
    .header-icon svg { width: 24px; height: 24px; fill: #fff; }
    .header h1 { font-size: 20px; font-weight: 600; }
    .header p { font-size: 13px; color: var(--text-muted); }

    .divider { border: none; border-top: 1px solid var(--border); }

    /* ── Card ── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .card-header {
      padding: 16px 20px 12px;
      font-size: 15px;
      font-weight: 500;
    }
    .card-body { padding: 0 20px 20px; display: flex; flex-direction: column; gap: 16px; }

    /* ── Form ── */
    label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    label .opt { font-size: 11px; color: var(--text-dim); margin-left: 4px; }

    input[type="text"], input[type="password"], input[type="number"], textarea {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 9px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      transition: border-color 0.15s;
    }
    input:focus, textarea:focus { border-color: var(--primary); }
    input::placeholder, textarea::placeholder { color: var(--text-dim); font-family: 'Inter', system-ui, sans-serif; }
    input:disabled, textarea:disabled { opacity: 0.5; cursor: not-allowed; }

    textarea { resize: none; min-height: 120px; font-family: 'Inter', system-ui, sans-serif; }

    .input-row { display: flex; gap: 10px; align-items: flex-end; }
    .input-row .grow { flex: 1; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 9px 20px;
      border: none; border-radius: var(--radius);
      font-size: 14px; font-weight: 500; font-family: inherit;
      cursor: pointer; transition: all 0.15s;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover:not(:disabled) { background: #d63a3a; }
    .btn-outline {
      background: transparent; color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-outline:hover:not(:disabled) { color: var(--text); border-color: var(--text-dim); }
    .btn-sm { padding: 7px 14px; font-size: 13px; }

    /* ── Guild Info ── */
    .guild-info {
      display: flex; align-items: center; gap: 12px;
      background: var(--bg-input); border-radius: var(--radius); padding: 12px 14px;
    }
    .guild-avatar {
      width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
    }
    .guild-avatar-placeholder {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--bg-hover); display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 16px; color: var(--text);
    }
    .guild-name { font-size: 14px; font-weight: 500; }
    .guild-members { font-size: 12px; color: var(--text-muted); }
    .badge-connected {
      margin-left: auto; font-size: 12px; font-weight: 500;
      padding: 3px 10px; border-radius: 20px;
      background: rgba(67,181,129,0.12); color: var(--success);
      border: 1px solid rgba(67,181,129,0.25);
    }

    /* ── Radio ── */
    .radio-group { display: flex; flex-direction: column; gap: 8px; }
    .radio-item {
      display: flex; align-items: center; gap: 8px;
      cursor: pointer; font-size: 14px; color: var(--text);
    }
    .radio-item input[type="radio"] {
      appearance: none; width: 18px; height: 18px;
      border: 2px solid var(--border); border-radius: 50%;
      background: var(--bg-input); position: relative; cursor: pointer;
    }
    .radio-item input[type="radio"]:checked {
      border-color: var(--primary);
    }
    .radio-item input[type="radio"]:checked::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 8px; height: 8px; border-radius: 50%; background: var(--primary);
    }

    /* ── Roles ── */
    .roles-scroll {
      max-height: 200px; overflow-y: auto;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 10px;
    }
    .roles-scroll::-webkit-scrollbar { width: 6px; }
    .roles-scroll::-webkit-scrollbar-track { background: transparent; }
    .roles-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .role-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 8px; border-radius: 6px; cursor: pointer;
      transition: background 0.1s;
    }
    .role-item:hover { background: var(--bg-hover); }
    .role-item input[type="checkbox"] {
      appearance: none; width: 16px; height: 16px;
      border: 2px solid var(--border); border-radius: 4px;
      background: var(--bg-input); cursor: pointer; position: relative;
    }
    .role-item input[type="checkbox"]:checked {
      background: var(--primary); border-color: var(--primary);
    }
    .role-item input[type="checkbox"]:checked::after {
      content: '';
      position: absolute; top: 1px; left: 4px;
      width: 5px; height: 9px;
      border: solid #fff; border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .role-dot {
      width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
    }
    .role-name { font-size: 13px; color: var(--text); }

    /* ── Slider ── */
    .slider-row { display: flex; align-items: center; gap: 14px; }
    .slider-row input[type="range"] {
      flex: 1; appearance: none; height: 6px;
      background: var(--border); border-radius: 3px; outline: none;
    }
    .slider-row input[type="range"]::-webkit-slider-thumb {
      appearance: none; width: 18px; height: 18px;
      background: var(--primary); border-radius: 50%; cursor: pointer;
    }
    .slider-row input[type="number"] {
      width: 70px; text-align: center; font-size: 13px;
    }

    .hint { font-size: 12px; color: var(--text-dim); margin-top: -8px; }

    /* ── Buttons row ── */
    .btn-row { display: flex; gap: 10px; }

    /* ── Progress ── */
    .progress-bar-wrap {
      display: flex; flex-direction: column; gap: 6px;
    }
    .progress-labels {
      display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted);
    }
    .progress-bar {
      height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: var(--primary); border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* ── Stats ── */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    @media (max-width: 500px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    .stat-card {
      text-align: center; padding: 12px 8px;
      border-radius: var(--radius); display: flex;
      flex-direction: column; align-items: center; gap: 2px;
    }
    .stat-card .num { font-size: 20px; font-weight: 600; }
    .stat-card .lbl { font-size: 11px; }
    .stat-total { background: var(--bg-input); }
    .stat-total .num { color: var(--text); }
    .stat-total .lbl { color: var(--text-muted); }
    .stat-success { background: rgba(67,181,129,0.1); border: 1px solid rgba(67,181,129,0.2); }
    .stat-success .num { color: var(--success); }
    .stat-success .lbl { color: rgba(67,181,129,0.7); }
    .stat-failed { background: rgba(240,71,71,0.1); border: 1px solid rgba(240,71,71,0.2); }
    .stat-failed .num { color: var(--danger); }
    .stat-failed .lbl { color: rgba(240,71,71,0.7); }
    .stat-dmclosed { background: rgba(250,166,26,0.1); border: 1px solid rgba(250,166,26,0.2); }
    .stat-dmclosed .num { color: var(--warning); }
    .stat-dmclosed .lbl { color: rgba(250,166,26,0.7); }

    /* ── Log ── */
    .log-area {
      height: 280px; overflow-y: auto;
      background: #060711; border: 1px solid var(--border);
      border-radius: var(--radius); padding: 12px;
      font-family: 'JetBrains Mono', monospace; font-size: 12px;
      display: flex; flex-direction: column; gap: 2px;
    }
    .log-area::-webkit-scrollbar { width: 6px; }
    .log-area::-webkit-scrollbar-track { background: transparent; }
    .log-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .log-line { display: flex; gap: 10px; line-height: 1.6; }
    .log-time { color: var(--text-dim); flex-shrink: 0; font-variant-numeric: tabular-nums; }
    .log-tag { flex-shrink: 0; font-weight: 600; width: 100px; text-align: right; }
    .log-msg { color: rgba(228,229,241,0.75); }

    .log-success .log-tag { color: var(--success); }
    .log-failed .log-tag { color: var(--danger); }
    .log-dm_closed .log-tag { color: var(--warning); }
    .log-ratelimit .log-tag { color: var(--orange); }
    .log-info .log-tag { color: var(--info); }
    .log-error .log-tag { color: #f55; }

    /* ── Footer ── */
    .footer {
      text-align: center; font-size: 12px; color: var(--text-dim);
      padding-bottom: 16px;
    }

    /* Hidden */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="header-icon">
        <svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
      </div>
      <div>
        <h1>Discord Bot DM Panel</h1>
        <p>Mass DM Control Panel</p>
      </div>
    </div>

    <hr class="divider" />

    <!-- Section 1: Bot Configuration -->
    <div class="card">
      <div class="card-header">Bot Configuration</div>
      <div class="card-body">
        <div>
          <label for="botToken">Bot Token</label>
          <div class="input-row">
            <div class="grow">
              <input type="password" id="botToken" placeholder="Enter your bot token" />
            </div>
            <button class="btn btn-outline btn-sm" id="toggleToken" type="button">Show</button>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="guildId">Guild (Server) ID</label>
            <input type="text" id="guildId" placeholder="Enter guild ID" />
          </div>
          <div>
            <label for="statusChannelId">Status Channel ID <span class="opt">(optional)</span></label>
            <input type="text" id="statusChannelId" placeholder="Channel for progress updates" />
          </div>
        </div>

        <div>
          <button class="btn btn-primary" id="connectBtn" type="button">Connect</button>
        </div>

        <div id="guildInfoBox" class="guild-info hidden">
          <img id="guildAvatar" class="guild-avatar hidden" crossorigin="anonymous" alt="" />
          <div id="guildAvatarPlaceholder" class="guild-avatar-placeholder hidden"></div>
          <div>
            <div id="guildName" class="guild-name"></div>
            <div id="guildMembers" class="guild-members"></div>
          </div>
          <span class="badge-connected">Connected</span>
        </div>
      </div>
    </div>

    <!-- Section 2: Send Options -->
    <div class="card hidden" id="sendSection">
      <div class="card-header">Send Options</div>
      <div class="card-body">
        <!-- Target mode -->
        <div>
          <label>Target</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="sendMode" value="all" checked /> Send to all members
            </label>
            <label class="radio-item">
              <input type="radio" name="sendMode" value="roles" /> Send to specific roles only
            </label>
          </div>
        </div>

        <!-- Roles -->
        <div id="rolesSection" class="hidden">
          <label id="rolesLabel">Select Roles (0 selected)</label>
          <div class="roles-scroll" id="rolesList"></div>
        </div>

        <!-- Delay -->
        <div>
          <label id="delayLabel">Delay between messages: 2s</label>
          <div class="slider-row">
            <input type="range" id="delaySlider" min="0.5" max="10" step="0.5" value="2" />
            <input type="number" id="delayNumber" min="0.5" max="30" step="0.5" value="2" />
          </div>
        </div>

        <hr class="divider" />

        <!-- Message -->
        <div>
          <label for="messageText">Message Content</label>
          <textarea id="messageText" placeholder="Type your message here...&#10;Use <user> to mention the recipient"></textarea>
          <p class="hint">Use &lt;user&gt; to mention the recipient. Example: Hello &lt;user&gt;, welcome!</p>
        </div>

        <!-- Buttons -->
        <div class="btn-row">
          <button class="btn btn-primary" id="sendBtn" type="button">Send Messages</button>
          <button class="btn btn-danger hidden" id="stopBtn" type="button">Stop</button>
        </div>
      </div>
    </div>

    <!-- Section 3: Progress & Logs -->
    <div class="card hidden" id="progressSection">
      <div class="card-header" id="progressTitle">Progress</div>
      <div class="card-body">
        <!-- Progress bar -->
        <div class="progress-bar-wrap" id="progressBarWrap">
          <div class="progress-labels">
            <span id="progressCount">0 / 0</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
          </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card stat-total">
            <span class="num" id="statTotal">0</span>
            <span class="lbl">Total</span>
          </div>
          <div class="stat-card stat-success">
            <span class="num" id="statSuccess">0</span>
            <span class="lbl">Success</span>
          </div>
          <div class="stat-card stat-failed">
            <span class="num" id="statFailed">0</span>
            <span class="lbl">Failed</span>
          </div>
          <div class="stat-card stat-dmclosed">
            <span class="num" id="statDmClosed">0</span>
            <span class="lbl">DM Closed</span>
          </div>
        </div>

        <hr class="divider" />

        <!-- Log -->
        <div>
          <label>Log</label>
          <div class="log-area" id="logArea"></div>
        </div>
      </div>
    </div>

    <p class="footer">Bot must have SERVER MEMBERS INTENT enabled in Discord Developer Portal. Deploy on Railway with gunicorn.</p>
  </div>

  <script>
    // ─── DOM refs ───
    const $ = id => document.getElementById(id);
    const botToken = $('botToken');
    const guildId = $('guildId');
    const statusChannelId = $('statusChannelId');
    const toggleTokenBtn = $('toggleToken');
    const connectBtn = $('connectBtn');
    const guildInfoBox = $('guildInfoBox');
    const guildAvatar = $('guildAvatar');
    const guildAvatarPlaceholder = $('guildAvatarPlaceholder');
    const guildNameEl = $('guildName');
    const guildMembersEl = $('guildMembers');
    const sendSection = $('sendSection');
    const rolesSection = $('rolesSection');
    const rolesLabel = $('rolesLabel');
    const rolesList = $('rolesList');
    const delaySlider = $('delaySlider');
    const delayNumber = $('delayNumber');
    const delayLabel = $('delayLabel');
    const messageText = $('messageText');
    const sendBtn = $('sendBtn');
    const stopBtn = $('stopBtn');
    const progressSection = $('progressSection');
    const progressTitle = $('progressTitle');
    const progressCount = $('progressCount');
    const progressPercent = $('progressPercent');
    const progressFill = $('progressFill');
    const statTotal = $('statTotal');
    const statSuccess = $('statSuccess');
    const statFailed = $('statFailed');
    const statDmClosed = $('statDmClosed');
    const logArea = $('logArea');

    let roles = [];
    let selectedRoles = new Set();
    let isSending = false;
    let abortController = null;

    // ─── Toggle token visibility ───
    toggleTokenBtn.addEventListener('click', () => {
      if (botToken.type === 'password') {
        botToken.type = 'text';
        toggleTokenBtn.textContent = 'Hide';
      } else {
        botToken.type = 'password';
        toggleTokenBtn.textContent = 'Show';
      }
    });

    // ─── Send mode radio ───
    document.querySelectorAll('input[name="sendMode"]').forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'roles') {
          rolesSection.classList.remove('hidden');
        } else {
          rolesSection.classList.add('hidden');
        }
      });
    });

    // ─── Delay sync ───
    delaySlider.addEventListener('input', () => {
      delayNumber.value = delaySlider.value;
      delayLabel.textContent = `Delay between messages: ${delaySlider.value}s`;
    });
    delayNumber.addEventListener('change', () => {
      let v = parseFloat(delayNumber.value);
      if (isNaN(v) || v < 0.5) v = 0.5;
      if (v > 30) v = 30;
      delayNumber.value = v;
      delaySlider.value = Math.min(v, 10);
      delayLabel.textContent = `Delay between messages: ${v}s`;
    });

    // ─── Connect ───
    connectBtn.addEventListener('click', async () => {
      const token = botToken.value.trim();
      const guild = guildId.value.trim();
      if (!token || !guild) return;

      connectBtn.disabled = true;
      connectBtn.textContent = 'Connecting...';
      guildInfoBox.classList.add('hidden');
      sendSection.classList.add('hidden');

      try {
        const [gRes, rRes] = await Promise.all([
          fetch('/api/guild-info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ botToken: token, guildId: guild }),
          }),
          fetch('/api/roles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ botToken: token, guildId: guild }),
          }),
        ]);

        const gData = await gRes.json();
        const rData = await rRes.json();

        if (!gRes.ok) {
          addLog('error', 'Connection failed: ' + (gData.error || 'Unknown'));
          showProgress();
          return;
        }

        // Show guild info
        if (gData.icon) {
          guildAvatar.src = gData.icon;
          guildAvatar.classList.remove('hidden');
          guildAvatarPlaceholder.classList.add('hidden');
        } else {
          guildAvatarPlaceholder.textContent = gData.name.charAt(0);
          guildAvatarPlaceholder.classList.remove('hidden');
          guildAvatar.classList.add('hidden');
        }
        guildNameEl.textContent = gData.name;
        let membersText = gData.memberCount.toLocaleString() + ' members';
        if (gData.onlineCount > 0) membersText += ' / ' + gData.onlineCount.toLocaleString() + ' online';
        guildMembersEl.textContent = membersText;
        guildInfoBox.classList.remove('hidden');

        // Roles
        if (rRes.ok) {
          roles = rData;
          renderRoles();
        }

        sendSection.classList.remove('hidden');
        addLog('info', 'Connected to ' + gData.name);
        showProgress();
      } catch (e) {
        addLog('error', 'Failed to connect: ' + e.message);
        showProgress();
      } finally {
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect';
      }
    });

    // ─── Render roles ───
    function renderRoles() {
      rolesList.innerHTML = '';
      selectedRoles.clear();
      roles.forEach(role => {
        const item = document.createElement('label');
        item.className = 'role-item';
        item.innerHTML = `
          <input type="checkbox" data-id="${role.id}" />
          <span class="role-dot" style="background:${role.color || '#4e5073'}"></span>
          <span class="role-name">${escHtml(role.name)}</span>
        `;
        const cb = item.querySelector('input');
        cb.addEventListener('change', () => {
          if (cb.checked) selectedRoles.add(role.id);
          else selectedRoles.delete(role.id);
          rolesLabel.textContent = `Select Roles (${selectedRoles.size} selected)`;
        });
        rolesList.appendChild(item);
      });
      rolesLabel.textContent = 'Select Roles (0 selected)';
    }

    // ─── Send DM ───
    sendBtn.addEventListener('click', async () => {
      const msg = messageText.value.trim();
      if (!msg) return;
      const mode = document.querySelector('input[name="sendMode"]:checked').value;
      if (mode === 'roles' && selectedRoles.size === 0) return;

      isSending = true;
      sendBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      setInputsDisabled(true);
      clearLogs();

      abortController = new AbortController();

      try {
        const res = await fetch('/api/send-dm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            botToken: botToken.value.trim(),
            guildId: guildId.value.trim(),
            message: msg,
            mode: mode,
            roleIds: Array.from(selectedRoles),
            delay: parseFloat(delayNumber.value) || 2,
            statusChannelId: statusChannelId.value.trim() || null,
          }),
          signal: abortController.signal,
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          let currentEvent = '';
          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEvent = line.slice(7);
            } else if (line.startsWith('data: ') && currentEvent) {
              try {
                const data = JSON.parse(line.slice(6));
                handleSSE(currentEvent, data);
              } catch {}
              currentEvent = '';
            }
          }
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          addLog('error', 'Connection error: ' + e.message);
        }
      } finally {
        isSending = false;
        sendBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        setInputsDisabled(false);
        abortController = null;
      }
    });

    // ─── Stop ───
    stopBtn.addEventListener('click', async () => {
      if (abortController) abortController.abort();
      try { await fetch('/api/stop', { method: 'POST' }); } catch {}
      isSending = false;
      sendBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');
      setInputsDisabled(false);
      addLog('info', 'Stopped by user');
    });

    // ─── SSE handler ───
    function handleSSE(event, data) {
      switch (event) {
        case 'log':
          addLog(data.status, data.message);
          break;
        case 'progress':
          updateProgress(data);
          break;
        case 'complete':
          updateProgress(data);
          progressTitle.textContent = 'Results';
          addLog('info', `Complete! Sent: ${data.sent} | Failed: ${data.failed} | DM Closed: ${data.dmClosed}`);
          break;
        case 'error':
          addLog('error', data.message);
          break;
      }
    }

    // ─── Progress ───
    function showProgress() {
      if (logArea.children.length > 0) {
        progressSection.classList.remove('hidden');
      }
    }

    function updateProgress(data) {
      progressSection.classList.remove('hidden');
      const done = data.sent + data.failed + data.dmClosed;
      const pct = data.total > 0 ? Math.round((done / data.total) * 100) : 0;
      progressCount.textContent = `${done} / ${data.total}`;
      progressPercent.textContent = `${pct}%`;
      progressFill.style.width = `${pct}%`;
      statTotal.textContent = data.total;
      statSuccess.textContent = data.sent;
      statFailed.textContent = data.failed;
      statDmClosed.textContent = data.dmClosed;
    }

    // ─── Log ───
    const TAG_MAP = {
      success: 'OK',
      failed: 'FAIL',
      dm_closed: 'DM CLOSED',
      ratelimit: 'RATE LIMIT',
      info: 'INFO',
      error: 'ERROR',
    };

    function addLog(status, message) {
      const now = new Date().toLocaleTimeString('th-TH');
      const tag = TAG_MAP[status] || 'LOG';
      const line = document.createElement('div');
      line.className = `log-line log-${status}`;
      line.innerHTML = `<span class="log-time">${now}</span><span class="log-tag">[${tag}]</span><span class="log-msg">${escHtml(message)}</span>`;
      logArea.appendChild(line);
      logArea.scrollTop = logArea.scrollHeight;
      showProgress();
    }

    function clearLogs() {
      logArea.innerHTML = '';
      progressTitle.textContent = 'Sending...';
      progressCount.textContent = '0 / 0';
      progressPercent.textContent = '0%';
      progressFill.style.width = '0%';
      statTotal.textContent = '0';
      statSuccess.textContent = '0';
      statFailed.textContent = '0';
      statDmClosed.textContent = '0';
    }

    // ─── Helpers ───
    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function setInputsDisabled(disabled) {
      botToken.disabled = disabled;
      guildId.disabled = disabled;
      statusChannelId.disabled = disabled;
      connectBtn.disabled = disabled;
      messageText.disabled = disabled;
      delaySlider.disabled = disabled;
      delayNumber.disabled = disabled;
      document.querySelectorAll('input[name="sendMode"]').forEach(r => r.disabled = disabled);
      document.querySelectorAll('#rolesList input').forEach(cb => cb.disabled = disabled);
    }
  </script>
</body>
</html>
